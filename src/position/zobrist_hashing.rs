use crate::constants::*;

use super::board::Board;

pub struct ZobristHasher {
    square_piece: [u64; 768],   //64 * 6 * 2
    castling_rights: [u64; 16], //for each combination of possible castling rights,
    en_passant_file: [u64; 8],
    black_on_move: u64,
    hash: u64,
}

impl Default for ZobristHasher {
    fn default() -> Self {
        let (square_piece, rest) = NUMS.as_slice().split_at(768);
        let (castling_rights, rest) = rest.split_at(16);
        let (en_passant_file, rest) = rest.split_at(8);
        let black_on_move = rest[0];
        ZobristHasher {
            square_piece: square_piece.try_into().unwrap(),
            castling_rights: castling_rights.try_into().unwrap(),
            en_passant_file: en_passant_file.try_into().unwrap(),
            black_on_move,
            hash: 0,
        }
    }
}

impl ZobristHasher {
    pub fn new() -> Self {
        Self::default()
    }

    pub fn new_from_numbers(nums: &Vec<u64>) -> Self {
        let (square_piece, rest) = nums.as_slice().split_at(768);
        let (castling_rights, rest) = rest.split_at(16);
        let (en_passant_file, rest) = rest.split_at(8);
        let black_on_move = rest[0];
        ZobristHasher {
            square_piece: square_piece.try_into().unwrap(),
            castling_rights: castling_rights.try_into().unwrap(),
            en_passant_file: en_passant_file.try_into().unwrap(),
            black_on_move,
            hash: 0,
        }
    }

    pub fn get_hash(&self) -> u64 {
        self.hash
    }

    pub fn set_hash(&mut self, hash: u64) {
        self.hash = hash;
    }

    pub fn toggle_sq_piece(&mut self, square: usize, piece: usize, color: usize) {
        //piece - 1 because 0 indicates NONE piece
        self.hash ^= self.square_piece[square + piece * 64 + color * 384];
    }

    pub fn toggle_moving_side(&mut self) {
        self.hash ^= self.black_on_move
    }

    pub fn toggle_castling_rights(&mut self, castling_rights: usize) {
        self.hash ^= self.castling_rights[castling_rights];
    }

    pub fn toggle_en_passant_file(&mut self, en_passant_file: usize) {
        self.hash ^= self.en_passant_file[en_passant_file]
    }

    pub fn dump_numbers(&self) -> Vec<u64> {
        let mut res = Vec::with_capacity(793);
        res.extend(&self.square_piece);
        res.extend(&self.castling_rights);
        res.extend(&self.en_passant_file);
        res.push(self.black_on_move);
        res
    }
}

impl Board {
    pub fn compute_hash(&mut self) {
        self.hasher.set_hash(0);
        for sq in 0..64 {
            let white_piece = self.players[WHITE].get_piece_at(sq);
            let black_piece = self.players[BLACK].get_piece_at(sq);
            if white_piece != NONE {
                self.hasher.toggle_sq_piece(sq, white_piece, WHITE);
            }
            if black_piece != NONE {
                self.hasher.toggle_sq_piece(sq, black_piece, BLACK);
            }
        }
        if self.us == BLACK {
            self.hasher.toggle_moving_side();
        }
        let state = self.get_state();
        let ep = state.get_en_passant_file();
        if ep != 0 {
            self.hasher.toggle_en_passant_file(ep - 1);
        }
        self.hasher
            .toggle_castling_rights(state.get_castling_rights() as usize);
    }
}

//hard coded zobrist-hashing numbers
const NUMS: [u64; 793] = [
    18422006497503122313,
    7347384725104522589,
    16844063233772178982,
    7401931632997713137,
    16878084395085784997,
    8675462740966919660,
    13202637185483274078,
    11308735258964540507,
    6038061093915115825,
    16416308317323633726,
    5745660668116425895,
    4447389004287599258,
    8355244875989641143,
    1091319372561329751,
    9517840879641133713,
    4037262061107558402,
    11929827525267751630,
    12612756172324896172,
    18248775867277469483,
    551759696510002086,
    4646485730897369052,
    10491457304269496084,
    5863711859535792739,
    2505563974533797168,
    13267725070824363879,
    979737590556896109,
    8258326890319252262,
    11114478134293336167,
    17616611873443336396,
    11444399988628307761,
    11977305113748937938,
    17356243065518906390,
    4646623281282590142,
    15313970895927296572,
    4630359975797460919,
    17770749806127746775,
    15264791680441556069,
    10150684673010783612,
    7054738334977263276,
    12358021282649513370,
    1856585581526281547,
    14347367020095963332,
    13443510055199791134,
    6607809714549746746,
    18393148338103523555,
    12066265688784697839,
    7366432427474613975,
    1474842957579382525,
    7949037966154042339,
    1814579389285955026,
    15810932704022773692,
    7898723839858867334,
    1308737475766343567,
    13876501062857487693,
    10701513463984690101,
    14086204557876840118,
    615708102505541468,
    16625735687114290173,
    2447455988470516723,
    14169356289747245654,
    7112085790733746260,
    1810182670639807960,
    16448906037727572601,
    14536998586226494253,
    10799817656567072815,
    3677492013899946997,
    8222698999619194113,
    9709282552260477033,
    2147161813390463981,
    1805153018498277150,
    12059378160417530439,
    15825099914721614811,
    18410589375599295646,
    10311246115757484563,
    4516226972871899041,
    17468875409770127370,
    7709278841617628211,
    7821251107614303971,
    5036280029927557473,
    12362578102960201151,
    7346629209795048274,
    3476510474662342322,
    6402073117965036630,
    12229708946244612130,
    17300054617376367090,
    7041940037794544655,
    15757737938467686184,
    14505711243813846716,
    15376896158358633368,
    10547859901308411206,
    7545881708531880397,
    13271455591925404890,
    13891284968111420051,
    1865760502508422052,
    10718397873438242480,
    2738441343701846108,
    6533681128014802351,
    9191233406852517006,
    4618400555982145995,
    12989456595712761284,
    14819800647514941936,
    6858542724292031742,
    4884725031573487543,
    10815779640499394909,
    17291871266115364081,
    11825583618873894961,
    13208174417274875661,
    910980608504608184,
    720943014696717526,
    12845620070367763959,
    13204841747271723240,
    9217970746919556368,
    2765137373482067003,
    16630409357859059371,
    14741963732213324855,
    4318309018782993609,
    7492732111366282295,
    11868373725779292504,
    9635716741770518198,
    226665422991223005,
    8817664962560032235,
    5687552615220721656,
    11066640720422940961,
    17353265191842827190,
    9367027745928543579,
    17530675413756124046,
    15885991755162345342,
    9466081210643833993,
    16990152320240385409,
    3785700456343502060,
    9198187013027851395,
    8650568968205918512,
    906069610263461956,
    11763447602052215247,
    11090041075604142851,
    2235281250376805638,
    15733566036021507306,
    4236558015293247090,
    543668113971518259,
    4880091763047581543,
    3612003018291599675,
    3103608914619074457,
    1962316783768171840,
    3539523319070950624,
    6613964240723947493,
    15178162011727175150,
    12822520518796961747,
    16658207046756620035,
    8371253884024377624,
    7999155215229163752,
    1859220175359360532,
    10367924517114442871,
    7302694453278968875,
    11768964570732857880,
    2658653666676270190,
    9035051851683088684,
    13887375308263774452,
    8174363908806208767,
    3136945434737571298,
    1406240750276813696,
    561895825585512382,
    14539359820151384920,
    5929194034453973392,
    2399063135360373686,
    12378022123929113314,
    1148437609016124759,
    17508067059488888023,
    8732824138460304549,
    9431772109657758305,
    12723275743011208551,
    5022680026902461462,
    16895318747542310590,
    12169523383325671152,
    3921233236537943936,
    9835181096246798840,
    10072379996705288455,
    7161724746520486269,
    12547625093958343525,
    10116237183042862945,
    3813021629690387140,
    15295250029518066507,
    17400946497239673846,
    4551669659122525799,
    8715193472262072173,
    14752574314277800134,
    6833568381978861995,
    10446740754425567508,
    14780099071939259912,
    8822689765125274478,
    2095416975960520702,
    2999014511644242178,
    11849234305766440914,
    13195902338302852818,
    10810702860623605371,
    1535542078072319525,
    3189668474166409471,
    8456818494736636585,
    9686901657366309998,
    14608587714592367126,
    2571661448235298340,
    17090707543484756830,
    14743166950480922022,
    9618112510184488366,
    17091363826784792396,
    10838881477813008599,
    16216141333169622173,
    17385719877299432269,
    14098327480672861016,
    8900610213631533937,
    16859103571152187745,
    5223984223265855705,
    4847895760317890429,
    3107735630859623715,
    4041701856570466162,
    14936797624857918907,
    16980434457883693184,
    12812080097635918609,
    9079369412862574534,
    8391041732434440139,
    7719986243625271154,
    4834093561493336170,
    9344946243832620938,
    1250588265167589436,
    6445240739471422564,
    1631048902456355040,
    9505964885308432923,
    14767339695076803661,
    4332447278946868155,
    9125781994523695438,
    16903300378788942253,
    1218728736399315017,
    1715003760736122939,
    7544395679323540624,
    16097106714246871595,
    3439010292592683224,
    12269804196745888352,
    11985869766392913932,
    7319444932228679660,
    6941432546569565286,
    9068106095789885876,
    12964037724282521853,
    14665825464572330600,
    9073393340288503403,
    12222616389093092715,
    9580845673859815170,
    14854647383918350021,
    13972804133717812118,
    7493130924599267719,
    7823757981952003043,
    8633007453850759569,
    4125836114947123604,
    15478900630908045698,
    7645970682622050653,
    2122673947037347191,
    2836528594093277319,
    16675445384705224753,
    8846368875360086835,
    903577402333598165,
    5658463204229102447,
    12545195336463058930,
    13254722526272601224,
    12696533248513517154,
    8679050449459890950,
    17826311871149973860,
    3671860524827692072,
    11922025682150136659,
    3703759399219955147,
    4881859442276605822,
    5601463810856254206,
    658961845409957702,
    5770677097712973804,
    335826196952208371,
    18228083660159356243,
    11005887025421735428,
    15452400503120316422,
    12537369638937229435,
    3691405224308137146,
    6308954368463263033,
    16445307941402347770,
    1635561177056482455,
    13186668745277664587,
    15190242291331482607,
    7498988626591591217,
    16170581485396500073,
    1714650268612300582,
    11159002282808058894,
    622890054734605266,
    11907686337586705065,
    16701003576673745307,
    9912945889483401433,
    15091617932189455305,
    4574269606839383521,
    2345676991109129275,
    2504942585985238964,
    3177592893613953421,
    5314075297812919969,
    17867427738495599191,
    2105084638863025779,
    16413635761081770176,
    12554598594213549614,
    13987845481212225827,
    18286335175151120773,
    1135553747705863065,
    2228639762501228846,
    2308829946471887809,
    7458118463337862064,
    4466123567088560854,
    2073965465361662447,
    17948855193393862661,
    383601370895782729,
    11477525496004447795,
    9114540740987549076,
    9886692557619786469,
    9720362396132204602,
    5763246100040050435,
    8241196962669968964,
    13133430085903323397,
    5527484252029940650,
    9165446845443891944,
    5238702334341878814,
    6562927474445688352,
    3321548287466500204,
    16509293121691500041,
    2987372477408196253,
    13796118699651834901,
    17312824610223578965,
    7710945972010926263,
    6788609724636572565,
    16404383563839976921,
    425383913674848980,
    16221647474830725638,
    16219479479134958149,
    3060961006158622629,
    4352722353299187368,
    2065486233760174413,
    3170476639546871902,
    986978143000948119,
    6629813627992714419,
    4749562209904052640,
    5898779941838842542,
    13275982842030205525,
    6782010982119904695,
    2473697826157362238,
    10784204167345555166,
    9010603544662346398,
    4693032871192985027,
    6944236249139802750,
    1408460383775437495,
    6421495348687791940,
    8858634102472198584,
    7892180653369346232,
    11234715891034091695,
    811567286281490527,
    11536204803211741554,
    15763725055375801810,
    12314765191774038738,
    9999764243341110074,
    4882065582288867756,
    3071727779580062013,
    1105337969265543243,
    11877126204197197695,
    7121886086491817222,
    17375522666093615452,
    17603905625176737483,
    9872250672232492573,
    3265351049614290170,
    4496132158825553639,
    4825427095816046115,
    9096790129245724699,
    17800384246432783129,
    14246384701689278182,
    1641167511780867203,
    12460851811555463354,
    1173946320162286180,
    104045487281190471,
    2699125413391265493,
    317895985992722756,
    9511883138134235199,
    7207469866752920344,
    14599065246887389448,
    9872483821708518600,
    3940974518328739457,
    12895905883568773052,
    6607636048426075010,
    5254820183828240985,
    7843015639095365390,
    8584441301311695479,
    14859792600604621770,
    17362374874045134163,
    15610149674252081456,
    13784318113453802867,
    12796517170095512093,
    14301195232948126349,
    775856132861428607,
    14961862636829122335,
    1162751895815581920,
    1992924858066468077,
    16750290464348222142,
    3063563779093638668,
    15624887850238450328,
    6570191294667292659,
    2825058991841317368,
    13849302826175379629,
    9254586438327938406,
    6846546377751607881,
    17318443131194132046,
    11391225698141697362,
    6649164770237490327,
    49128446126607320,
    15654577279240217443,
    3181678705120983285,
    10752824172775853688,
    9623177663389721931,
    2556106165206647395,
    14625833002437523017,
    13304461365456409046,
    4919262106744918741,
    16264493331905680294,
    17396656808073393599,
    7128065615432924283,
    1261642810431797761,
    8395543505308324711,
    8565390410070490907,
    16300354214843154505,
    17544893522632198938,
    2641742461507426328,
    8018016930176143800,
    13607960572692961687,
    10912936416196342019,
    11772200886954793946,
    5542626652635719226,
    5686153927818078124,
    16296523706248016344,
    9878860661704174885,
    16809872924238804071,
    4962118985558375031,
    14718248344924780451,
    18242013361909332360,
    6586080313969261356,
    7379758801651280061,
    3277282182529102741,
    15046256014468859366,
    14765840785891920526,
    201956152352392939,
    15859402123678200729,
    7322980345929140997,
    2929557709054869131,
    5780978427374722567,
    17848353309503480054,
    4224133985524265621,
    15802739446002649275,
    2487106973089933234,
    16638070983791119383,
    11902318271974604653,
    16900596856380073182,
    10945687599479479057,
    5101355028589814014,
    9338966013148909942,
    7447209284610488534,
    11512607394063467358,
    10328525682946461242,
    811545867887778643,
    13614085206258778630,
    7708358442217765056,
    15602983189975809345,
    14358614354113529474,
    5646715180582421549,
    15186027188029149576,
    5073058849835521039,
    1005693710174235084,
    3461303046796083453,
    11713120934901905721,
    1732013610405043360,
    7475311707721661228,
    4594812044593271767,
    14535173527221729351,
    16362842491027810643,
    906051540568048123,
    16154672635600262206,
    15333688484945850796,
    12208815022969662417,
    18027947599762854904,
    6351972499013495355,
    8260527493943061952,
    910151061714600930,
    1066234748780902107,
    1204581956164300945,
    6778298853468962832,
    16493862722048825248,
    17415588973064578914,
    15719131713943118468,
    6298999452744440030,
    6583917502514205543,
    10325415560551898582,
    2682203219056511412,
    12949094135770538996,
    3490684649571320371,
    2701450037512162765,
    11128577355597949179,
    14829075284470989584,
    12748975445610841388,
    3109877137113992430,
    1375347040522218298,
    2612968962181074767,
    8503946059913258824,
    10069525836755632883,
    12781732411943991221,
    1456504217827975278,
    18501652268858767,
    7847642022945727641,
    17436664994781290678,
    14052331559321626819,
    14009421143315608253,
    1295452360286739389,
    18399883846021401147,
    2956294591004685617,
    6005085589539598641,
    6956042064784279578,
    14734227060621663798,
    3508539565125709434,
    643164547190368577,
    14963439232861625347,
    18109845475789227815,
    11927078169519002492,
    6681559205190944696,
    1841475523280006377,
    6023615258339606607,
    5801333982355453710,
    4857437857960124138,
    16003182930098145632,
    7223616089057747536,
    5161855832093340625,
    12784852665284174264,
    8929028599620936441,
    6976914758058735173,
    9704611748428999799,
    3422412029127316596,
    13789071073115413695,
    6260825785455072425,
    1825013306640651972,
    13379069483220114020,
    1353797698335667530,
    12560839889422663605,
    12289439702170968442,
    1833236822096087584,
    16857785644051914052,
    8609409251501809608,
    3488390099497858956,
    4413235355889018252,
    14808785869677690754,
    1013120365025285412,
    9920462742135077254,
    11090426978475216719,
    11260782327886964592,
    5615847488778446286,
    1983645255713301347,
    1135094525421825193,
    4982690189118723965,
    18330703357762347071,
    3694755296748472259,
    3397757000369515718,
    16385217600835816819,
    1976218618403830562,
    10864878861367155343,
    528669826392934812,
    8286143713612391082,
    15913928928689702319,
    17973760087734617805,
    12840922257066069367,
    1113098777085628383,
    8700001795721356433,
    970352916345287546,
    13401727329280578553,
    6909106733524611848,
    17819173533422642341,
    13801894589245944011,
    1696702357346718353,
    11496760151556518948,
    11362449143217285062,
    3524956339355427084,
    13436502983535496714,
    7065060328434420761,
    890593756051338161,
    1369769432988910783,
    4709363761974082255,
    13045410257793747765,
    794168011932128840,
    9294245728859550871,
    9774581958429231737,
    9353104312270831519,
    1365719491035403283,
    6687934211850594754,
    11804596511755211843,
    8711366903845408922,
    14677273965588633575,
    16316382893772382559,
    6941768560530757285,
    6646210211709176639,
    16267120243636266325,
    15204540319084802863,
    718164174802496232,
    10577834411716060651,
    17067603155178421996,
    14052009687676816108,
    17153494843563426989,
    12394634484302255327,
    3013318039895817761,
    2322742908320674433,
    10248310683773829651,
    260645552326287230,
    17261230829857341695,
    6130544043707998,
    3754803014327517509,
    1071130034400816291,
    7595972895859768801,
    8471998369648006644,
    6890901993284282364,
    15735087246189882176,
    5050455832499559052,
    5047686176553280058,
    11999772731584476203,
    4344519238013599802,
    7004081229366562073,
    6439355390853911648,
    6905530016466397667,
    10271625378474706541,
    10294678858032907959,
    2715114388750788362,
    14988344424977361572,
    12676747756414178890,
    8078423172691107308,
    17861478690991859737,
    2963230104028492208,
    10082326154197143424,
    17484523935044929247,
    13423865203812958606,
    8451216024224413990,
    16517255085607452693,
    7074284339657593632,
    18181728499889329412,
    16527142946014908991,
    1805856969014728570,
    15218716271252475218,
    5597706161978673864,
    3050597495687522432,
    12432886417137254082,
    17325381631290315655,
    14273541289795037364,
    17412383171498380657,
    736865773623913706,
    6181200579949749322,
    7607688849919963130,
    10605186010201441563,
    2329530267764619171,
    9024072371542308289,
    14356143218582007598,
    3563560126967513135,
    16693024226749268992,
    1863469951293307688,
    14545243345871061480,
    12917757905991594055,
    2707718057119282868,
    9853384389650223019,
    1735620226614474830,
    5492743426631770926,
    15010136987931352794,
    2120665912943506367,
    7557200929778730025,
    16011539843023838364,
    9881508302862815715,
    2420352398169962941,
    15362005829481133752,
    9636248417575603143,
    9854587824007311718,
    15901982730085888541,
    14735345817282145789,
    14604368354778526258,
    14035368860717403060,
    7178853020467773728,
    14703580862328022572,
    4851302143214049341,
    6069196681239597855,
    5432752306425415594,
    8712078132760336240,
    7866595087440335549,
    14405145003250878487,
    11849522932084613569,
    11006031840333052220,
    14265563647552792214,
    7057923995566199520,
    13890851666192587389,
    16890059717726609057,
    15458686639819707285,
    17814657731817976868,
    6040496106437115307,
    11165132502541321693,
    3864082958969096696,
    8738282343279103163,
    15249797630138149449,
    8798837462860058150,
    10934178336162082491,
    5810104719130333893,
    12822170538930477576,
    3426400416751145551,
    773004269584046821,
    18231402323885512223,
    826016822887873500,
    13169594278078086235,
    15795841299473190900,
    5525911180560516363,
    10824256448027229091,
    2683249835479006396,
    10692756360818718343,
    12053247578890167473,
    1951356439075718451,
    17955149715202403362,
    14683328593698790792,
    6789430196890291259,
    14056667774825698335,
    813437266247417648,
    4499833957184594727,
    9992060877913772484,
    12550967698874543616,
    1158083302470226976,
    7631086343131284851,
    5775455052232272326,
    17517278799024801655,
    2437069404354074707,
    5350154976507827504,
    3041596808139252659,
    5085666846310508630,
    9935742096889045489,
    7517661558718522803,
    3074669644793834885,
    9123744070594528519,
    1524942206007590197,
    1831937302148261896,
    7286241259697819708,
    2420394376252856872,
    8610146742371710491,
    7925121616461218698,
    5094884091877920103,
    17876275938593739869,
    10840206611081012457,
    14769646508658417439,
    10630829770232492375,
    2183638153513210508,
    7576459047693309818,
    9189188185650702681,
    530626360094577572,
    17471181983655006753,
    4401539249317690597,
    15948968044142143907,
    185826735994242300,
    8322136945878528299,
    1014842042140861118,
    5275276076274353595,
    1936340391931820775,
    14420758024920309446,
    18217141025241245477,
    3457779860768893550,
    1227111812961544593,
    4244219651917727824,
    7791928139544387899,
    569196266372531415,
    12894033519987034208,
    15380224168580958088,
    8744498655453174856,
    3396673801986337082,
    12102796838645006499,
    2232452012946376559,
    8398116622402674768,
    6446104993313683021,
    5762172840771664853,
    3527633233394441527,
    1917532043516701383,
    922794738155452637,
    18292216004610320283,
    11730611377919904558,
    8566104477129374017,
    13987643252753381315,
    15310446974405742183,
    706826175969638574,
    12720001383027745760,
    10966537070172555230,
    4299899582200828773,
    809415959187210025,
    6472015044958639347,
    5833913893055525850,
    15501911729206450338,
    884801388503435021,
    14155142895099846791,
    7529505727098150428,
];
